package main

import (
	"errors"
	"fmt"
	"slices"
	"strings"
	// "time"
)

type Coordinate struct {
	x, y int
}
type Guard struct {
	coordinates Coordinate
	dx, dy      int
}

func main() {
	rows := strings.Split(input, "\n")
	// 1658, too high
	// 1657, not correct

	m := make(map[Coordinate]bool)

	guard, err := findGuard(rows)
	if err != nil {
		panic("lol")
	}

	guardPositions, _ := solve(guard, rows)
	fmt.Println(len(guardPositions))
	drawMap(rows, guardPositions)

	for i := 0; i < len(guardPositions)-1; i++ {
		currentGuard := guardPositions[i]
		nextGuard := guardPositions[i+1]
		if currentGuard.coordinates == nextGuard.coordinates {
			continue
		}
		// nextTile, _ := query(nextGuard.coordinates, rows)
		// fmt.Println("queried tile:", string(nextTile))

		if m[nextGuard.coordinates] != true {
			_, looped := solve(currentGuard, rows, nextGuard.coordinates)
			if looped {
				m[nextGuard.coordinates] = true
			}
		}

	}

	fmt.Println(len(m))
}

func clearScreen() {
	fmt.Print("\033[H\033[2J")
}

func solve(guard Guard, rows []string, addedWall ...Coordinate) (guardPositions []Guard, looped bool) {
	for {
		guardPositions = append(guardPositions, guard)
		upcomingCoordinate := Coordinate{guard.coordinates.x + guard.dx, guard.coordinates.y + guard.dy}
		upcomingTile, err2 := query(upcomingCoordinate, rows)
		if err2 != nil {
			// guard is at the edge
			return guardPositions, false
		}

		if upcomingTile == '#' || (len(addedWall) > 0 && upcomingCoordinate == addedWall[0]) {
			switch {
			case guard.dx == 0 && guard.dy == -1:
				guard.dx = 1
				guard.dy = 0
			case guard.dx == 1 && guard.dy == 0:
				guard.dx = 0
				guard.dy = 1
			case guard.dx == 0 && guard.dy == 1:
				guard.dx = -1
				guard.dy = 0
			case guard.dx == -1 && guard.dy == 0:
				guard.dx = 0
				guard.dy = -1
			}
		} else {
			guard.coordinates.x += guard.dx
			guard.coordinates.y += guard.dy
		}

		if slices.Contains(guardPositions, guard) {
			return guardPositions, true
		}
	}
}

func drawMap(rows []string, guardPositions []Guard, addedWall ...Coordinate) {
	clearScreen()
	fmt.Println("")
	for y, row := range rows {
		for x, v := range row {
			currentCoords := Coordinate{x, y}
			if len(addedWall) > 0 {
				if currentCoords == addedWall[0] {
					fmt.Print("â–ˆ")
					continue
				}
			}

			guardHasBeenHere := false
			for i, guard := range guardPositions {
				if guard.coordinates == currentCoords {
					if i == 0 {
						fmt.Print("\033[42m")
					}
					if i == len(guardPositions)-1 {
						fmt.Print("\033[41m")
					}
					guardHasBeenHere = true
					switch {
					case guard.dx == 0 && guard.dy == -1:
						fmt.Print("^")
					case guard.dx == 1 && guard.dy == 0:
						fmt.Print(">")
					case guard.dx == 0 && guard.dy == 1:
						fmt.Print("v")
					case guard.dx == -1 && guard.dy == 0:
						fmt.Print("<")
					}
					fmt.Print("\033[0m")
					break
				}
			}

			if !guardHasBeenHere {
				if v == '.' {
					fmt.Print(" ")
				} else {
					fmt.Print("\033[30m")
					fmt.Print(string(v))
					fmt.Print("\033[0m")
				}
			}
		}
		fmt.Println("")
	}
}

func query(coords Coordinate, rows []string) (rune, error) {
	width := len(rows[0])
	height := len(rows)

	if coords.x < 0 || coords.x >= width || coords.y < 0 || coords.y >= height {
		return '_', errors.New("out of bounds")
	}

	return rune(rows[coords.y][coords.x]), nil
}

func findGuard(rows []string) (guard Guard, err error) {
	width := len(rows[0])
	height := len(rows)

	for searchX := range width {
		for searchY := range height {
			searchCoords := Coordinate{searchX, searchY}
			char, _ := query(searchCoords, rows)
			switch {
			case char == '^':
				return Guard{searchCoords, 0, -1}, nil
			case char == '>':
				return Guard{searchCoords, 1, 0}, nil
			case char == 'v':
				return Guard{searchCoords, 0, 1}, nil
			case char == '<':
				return Guard{searchCoords, -1, 0}, nil
			default:
				continue
			}
		}
	}

	return Guard{}, errors.New("couldn't find the guard")
}

// var input = `....#.....
// .........#
// ..........
// ..#.......
// .......#..
// ..........
// .#..^.....
// ........#.
// #.........
// ......#...`

var input = `..........#..........#.#.......................................................................#...............#......#...#.......
........................................#..#..........#.........#..#..............................................................
.........#.......................................................................................................#................
..................................#.#..................................#..#.......#.....#.#............#.#........................
...#.......................................................#.........#...................#.................#......................
...............#.........#...........#................................................#..............#...........#.............#..
...................#..#..................................................................#........................................
........##..............................##................................#.....................#...#.............................
................................#...................#...........#.#...........................................................#...
......#......#...........................................#............................................#...#..#....#...............
............................#...#......#.....#.........#...#..#..............#....#...................#.........................#.
....................##.#........#.........#.............#......................#.#....#..............#........................#..#
#....................#......#..........#................................................................................#.........
..............#.............................................................#..........................#........#.....#..........#
.....................#........#......##.#.........#..........#.##.......................................#....#....................
................................................................#..#...........#.........#........................................
...............#..........#..#....#.#.#..................................#................................#..................#....
...................#....#.........................................................................................................
....#........................................................#......#......#.......................................#............#.
................................................#...#...........................................................#.................
..............#............................#.#.........................................#....#.....................................
...........#....#......#..................................................................#.....#..........#.............#.#......
...........................................#........#.#.........#.................#.....#.........................................
.............#.........#.........................#......#.....................#.#.................................................
.............#.....#................#...................................................#.........................................
..#....#............#................#...........................#..................#............#................................
#............................................................#......#..................................#...............#.......#..
.........................#...#.................................................................#..#...........................#..#
.................#.......................................#...............................#...#...#............#..........#........
......................#.........#...............#......#................................#.#....#.......#..........................
.#......##.................................#.................#...#.................#............................................#.
..#..................#.....#.#......#................................#..#...#......##....#..........#..................#..........
.................................................................................#...................................#............
..............................#..#...............................#....#.............................#.......#..................#..
..........#........#.....................................#..............#.....#..#................#........#.#..................#.
....................................#....#..........#........##...................................................................
.......#............................##.......#....#................................................................#.#............
.......................#......................................................#.................#.................................
.......#...................#..................................................................................................#...
.........#.....#................................#...............#........#.....................................#................#.
..#...........................#.....#..........#............................................#........#........#.#.................
...#.........#.............................#......#......................#.......................................#.......#.......#
.........................#.........#........#....................#..................#....#...#.................#..................
...............#.....................................................#....#....^............#.....................................
.......#.......#.....#.............#...........#...#..................................#...#.#....#.........................#......
.............#....................#..................................................#.........................#..................
......................................................##..........................................................................
.....................................#.....................................................................#............#..#....#.
#......................#....................#...#..................#....#.......................................#........#........
.#.....................................................................#...........................#....................##........
............#............#.........................#.........#.....................#..#........#...............................#..
.......#..#...........................................................#..#........#................#................#.............
..............................................................................................................#...................
..#............................#.....#.............#...............#..................................................#...........
..#........#..........................................................................#...........#.....##...................#....
..#.........#...................................#.................................................................................
...#.#......................#.......#...........#.........................................................#..........#............
.............#......#............#............................................................#......#............................
..............#......#...................................................................................................#........
..............#.#............................................................................#......##............................
...........#....................#...................#......#..............#.........................#.....#...#.............#.....
.................#......#................................................................................#...............#........
..#...........................................................................................#...................................
#.............#.......................#..#.....................................#..#.....#.....................#...................
.........#..#...#......#.......#................................#..............#.........#..........................#......#......
.....##...........#................................................................................................#..........#...
.#.........#....................................................##.............................#...#.........#....................
............#...............................#.#...............................................#...............................#...
...............................#..................#...........................#..............................................#....
.#..........#....#.............#.....#.....................#.....................#...................#.........................#..
.............................................................#................##..............#...................#...............
..........................##.........#................................................................................#...........
........#..#...........................#...................................................................#......................
..#.....#...................................................................#.....#....#..#.......#.......#.....#.....#...........
....................................#.......#....#......................................#........................#...........#....
...............#..............#.................#...............#....#....................................................#.......
....#..................#..........................................................................#.......#..........#............
..#...................................................#...............#...............................#......#................#...
.......#............#............................#.......................................#...#....................##..............
...............................#.......#................................#..............#....................#.....................
...........................#..............................................#..........................................#.#..#.......
....#........#....................#...........................................................................................#...
#..................#.....................#....................................#.#............#...................#................
....#........#...#............................#...#.......................#...............#........#....#.........................
.............................................................................................#....#...............#..#............
.........#..........#...........................................................#.#........................#..................#...
.....................................#................#.........#.#..........##......................#..#.........................
.....#..#.....................................................................#.#................................##...............
...............................#....#.#..................................................#.#.........................#........#...
#.......................................##.....#..........................#..#....................#.........#..........#..........
......#.#.............#....##...................................................................#................#....#......#....
..................#...#........................................#........................................#...#.....................
....................#...#...........##...................#..#....#.............................#......#............#..............
.........#.........................................................................#..........#...................................
......................................#...................................................................#.#.#..................#
.......#...#.....#........#..............#................#.........................#.#...........#.#.............#.......#.......
...#.................#......#...........#.............#.....................................#.....................................
.#...........................................................................................................#....................
............#..........#.......................#...........................................................................#....#.
......#....#...#.........................#......#......................##....#.......#.....................#....#.................
....................................#..........................#.......#.......#......................................#........##.
...................#..................................................................................#..............#.#..........
....#..........................#.....................#.#.........#...#......#..#....#.............................................
..................#......#................#........................................#...#........#.................................
...............................#.........#..................................................#.....................................
..................#..............................................#...............#...........#..#.................................
...........................#........................................................#........#....................................
.................#.......#.........##.............#...#....#......................#.......#.......................................
...........#...............#........................................................................#.#...........................
...........#..........#..........................#.....................#....#.........#...................##...#.........#........
.......#.............#........#...........................................#.................................................#.#...
.....................#..................................#.#......#...................#.........................#...#....#..##.....
.......#...................#.............#..#..................................................................#..................
..#........#........................#............#..#...#...........................#......................................#.#....
.............................#..#.......#.........#.....................................................................##...#....
..............##................#........................#..................................................#.....#...#...........
.............#..............#......#..............................................................#...................#...........
#...#............#...........##.............#..........................................#..........................................
..........................#.....#...................#....................#................#.......................................
.....................................................#..................................................................#...#.....
..................#.#........#....#.#.#..#...............................................#.....###..#.........................#...
.#...#.........#..........#.......................................................................#.#............#............#...
...#..............................#.............................#.#............................................#..................
#................................................#..#..........................................................#...............#.#
........................................#.............#..............#...............#.........#...#..............................
..............................#.................#..................#................#.....#.......#..........#....................
............#.......#...........#.........................................................................................#.......
#.#..............................#................#.#...................#.....................#.....................#......#......
.....#..#.......##...........................................#............................#.......................................
.......#..#..#.........#..........................#.#....#..........................#...#........................#.....#..........`
